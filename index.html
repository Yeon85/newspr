<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë‰´ìŠ¤ â€“ ë¬´í•œìŠ¤í¬ë¡¤Â·ìŠ¬ë¼ì´ë”Â·ë³´ê¸°</title>
<style>
  :root{ --bg:#f5f6f8; --card:#fff; --ink:#222; --ink2:#666; --line:#e9e9ee; --brand:#0b5bd3; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink)}
  body.no-scroll{ overflow:hidden; }

  /* Header */
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
  .bar{max-width:520px;margin:0 auto;display:flex;align-items:center;gap:8px;padding:10px 12px}
  .chip{min-width:34px;height:34px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;background:#fff}
  .title{font-weight:700;margin-left:6px}
  .bar-right{margin-left:auto;display:flex;gap:8px}

  /* Tabs */
  .tabs{max-width:520px;margin:0 auto;display:flex;gap:10px;padding:10px 12px 6px;background:#fff;position:sticky;top:56px;z-index:19;border-bottom:1px solid var(--line)}
  .tab{padding:7px 14px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:14px;cursor:pointer}
  .tab.is-active{background:var(--brand);border-color:var(--brand);color:#fff}

  /* Page */
  .wrap{max-width:520px;margin:0 auto;padding:10px 12px 40px}
  #topSpacer,#bottomSpacer{height:0}
  .list{display:block}
  .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;margin-bottom:14px}

  /* ===== ë©”ì¸ ì¹´ë“œ ìŠ¬ë¼ì´ë” ===== */
  .mini-slider{
    position:relative;border-radius:12px;overflow:hidden;background:#ddd;
    overscroll-behavior:contain; touch-action:pan-y;
  }
  .mini-slides{display:flex;transition:transform .35s ease}
  .mini-slide{min-width:100%}
  .mini-slide img{
    display:block;width:100%;aspect-ratio:4/5;object-fit:cover;  /* 280Ã—350 ë¹„ìœ¨ */
    cursor:pointer; -webkit-user-drag:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .mini-slider, .mini-slides, .mini-slide img{ overscroll-behavior:contain; touch-action:pan-y; }

  /* â€¹ â€º : í•­ìƒ ë³´ì´ë„ë¡(ìš”ì²­) */
  .mini-nav{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none;opacity:1}
  .mini-nav button{pointer-events:auto;border:none;background:rgba(0,0,0,.35);color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer}

  .mini-dots{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px 0 6px}
  .mini-dot{width:8px;height:8px;border-radius:50%;background:#cfd3da;cursor:pointer}
  .mini-dot.active{background:var(--brand)}

  /* Caption 1ì¤„ + ë”ë³´ê¸° */
  .caption{margin-top:2px;font-size:14px;line-height:1.55;color:#222;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;overflow:hidden}
  .caption.expanded{-webkit-line-clamp:unset;display:block}
  .more-btn{display:inline-flex;gap:4px;align-items:center;margin-top:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#333;cursor:pointer}
  .more-btn[hidden]{display:none!important}
  .meta{display:flex;justify-content:flex-end;color:#666;font-size:12px;margin-top:6px}

  .sentinel{height:24px}

  /* ====== Fullscreen Viewer ====== */
  .viewer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999;}
  .viewer{position:fixed;inset:0;display:none;z-index:1000;overflow:auto;overscroll-behavior:contain}
  .viewer .sheet{max-width:520px;margin:20px auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.2);padding:14px}
  .viewer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .viewer-title{font-weight:700}
  .viewer-close{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}

  .viewer-slider{position:relative;border-radius:12px;overflow:hidden;background:#ddd;overscroll-behavior:contain}
  .viewer-slides{display:flex;transition:transform .35s ease;touch-action:pan-y}
  .viewer-slide{min-width:100%}
  .viewer-slide img{
    display:block;width:100%;aspect-ratio:4/5;object-fit:cover;
    touch-action:none; transform-origin:center center; will-change: transform;
    cursor:pointer; -webkit-user-drag:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .viewer-dots{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px 0 6px}
  .viewer-dot{width:8px;height:8px;border-radius:50%;background:#cfd3da;cursor:pointer}
  .viewer-dot.active{background:var(--brand)}
  .viewer-nav{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%)}
  .viewer-nav button{border:none;background:rgba(0,0,0,.35);color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer}

  .viewer-caption{margin-top:8px;font-size:14px;line-height:1.7;color:#222}
  .viewer-meta{display:flex;justify-content:flex-end;color:#666;font-size:12px;margin-top:8px}
  .viewer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .viewer-actions .ghost{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
  .viewer-actions .primary{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}

  /* í™•ëŒ€ ì¤‘ ì»¤ì„œ í”¼ë“œë°± */
  #viewerSlider.is-zoomed  .viewer-slide img { cursor: grab; }
  #viewerSlider.is-zoomed.is-panning .viewer-slide img { cursor: grabbing; }

  .mini-slider:focus { outline:2px solid var(--brand); outline-offset:2px; }

  /* ===== ë¬¸ì¥(ì‘ì€ ë‹¨ë½) í˜•ê´‘íœ ===== */
  .viewer-caption .seg{
    padding: 0 2px;
    border-radius: 4px;
    transition: background-color .2s ease, box-shadow .2s ease;
  }
  .viewer-caption .seg.is-reading{
    background: linear-gradient(transparent 55%, #fff59d 0);
    box-shadow: inset 0 -6px 0 #fff59d;
  }
  .viewer-caption .seg:hover{
    background: linear-gradient(transparent 55%, #e8f0fe 0);
    box-shadow: inset 0 -6px 0 #e8f0fe;
    cursor: pointer;
  }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="chip" aria-label="ë’¤ë¡œ">â†</div>
      <div class="title" id="pageTitle">ë‰´ìŠ¤</div>
      <div class="bar-right">
        <div class="chip" aria-label="í™ˆ">ğŸ </div>
        <div class="chip" aria-label="ë©”ë‰´">â‰¡</div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="ë‰´ìŠ¤/í™ë³´">
    <button class="tab is-active" data-type="news" aria-selected="true">ë‰´ìŠ¤</button>
    <button class="tab" data-type="pr" aria-selected="false">í™ë³´</button>
  </div>

  <main class="wrap">
    <div id="topSpacer"></div>
    <section id="list" class="list"></section>
    <div id="bottomSpacer"></div>
    <div id="sentinel" class="sentinel" aria-hidden="true"></div>
  </main>

  <!-- ====== Viewer ====== -->
  <div id="viewer-backdrop" class="viewer-backdrop"></div>
  <div id="viewer" class="viewer" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="sheet">
      <div class="viewer-header">
        <div class="viewer-title" id="viewerTitle">ë‰´ìŠ¤</div>
        <button class="viewer-close" id="viewerCloseBtn" type="button">ë‹«ê¸°</button>
      </div>

      <div class="viewer-slider" data-index="0" id="viewerSlider">
        <div class="viewer-slides" id="viewerSlides"></div>
        <div class="viewer-nav">
          <button id="viewerPrev">â€¹</button>
          <button id="viewerNext">â€º</button>
        </div>
      </div>
      <div class="viewer-dots" id="viewerDots"></div>

      <div class="viewer-caption" id="viewerCaption"></div>
      <div class="viewer-meta" id="viewerDate"></div>

      <div class="viewer-actions">
        <button class="ghost"   id="viewerShareBtn"  type="button">ê³µìœ </button>
        <button class="ghost"   id="viewerPlayBtn"   type="button">ì¬ìƒ</button>
        <button class="primary" id="viewerListBtn"   type="button">ëª©ë¡</button>
      </div>
    </div>
  </div>

<script>
/* ================================
   ë”ë¯¸ í…ìŠ¤íŠ¸
================================ */
const DUMMY_SENTENCES = [
  "ì „ì„¸ë³´ì¦ê¸ˆ ë°˜í™˜ì„ ë‘˜ëŸ¬ì‹¼ ë¶„ìŸì´ ì´ì–´ì§€ë©´ì„œ ì„ì°¨ì¸ì˜ ì •ë³´ ë¹„ëŒ€ì¹­ í•´ì†Œê°€ ì‹œê¸‰í•˜ë‹¤ëŠ” ì§€ì ì´ ë‚˜ì˜¨ë‹¤.",
  "ì •ë¶€ëŠ” ì„ëŒ€ì°¨ ì‹ ê³ ì œ ë³´ì™„ê³¼ ë³´ì¦ ë³´í—˜ ì˜ë¬´í™” í™•ëŒ€ë¥¼ ì˜ˆê³ í–ˆì§€ë§Œ í˜„ì¥ì˜ ì²´ê°ë„ëŠ” ì—¬ì „íˆ ë‚®ë‹¤.",
  "ì „ë¬¸ê°€ë“¤ì€ ê³„ì•½ ì „ ë‹¨ê³„ì—ì„œ ë“±ê¸°ë¶€ í™•ì¸ê³¼ í™•ì •ì¼ì, ì „ì…ì‹ ê³ ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜ ë³´ì¦ì´ë ¥ê³¼ ì²´ë‚©ì •ë³´ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ì‚´í”¼ë¼ê³  ì¡°ì–¸í•œë‹¤.",
  "ê¸€ë¡œë²Œ ê¸ˆìœµì‹œì¥ì€ ë¯¸ ì—°ì¤€ì˜ ê¸ˆë¦¬ ì¸í•˜ ì‹œì ì„ ë†“ê³  í˜¼ì¡°ì„¸ë¥¼ ë³´ì´ëŠ” ê°€ìš´ë° ìœ„í—˜ìì‚° ì„ í˜¸ê°€ ì¼ì‹œì ìœ¼ë¡œ íšŒë³µë˜ëŠ” ëª¨ìŠµì´ë‹¤.",
  "êµ­ë‚´ ì£¼íƒë‹´ë³´ëŒ€ì¶œ ê¸ˆë¦¬ëŠ” ë³€ë™í­ì´ ì»¤ì¡Œê³ , ì¤‘ë„ìƒí™˜ ìˆ˜ìˆ˜ë£Œ ë©´ì œ ê¸°ê°„ì„ í™œìš©í•´ì•¼ ì´ì ë¶€ë‹´ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.",
  "ì¼ë¶€ ì§€ì—­ì€ ì—­ì „ì„¸ê°€ ì‹¬í™”ë˜ë©° ê¹¡í†µì „ì„¸ ìš°ë ¤ê°€ ë†’ì•„ì¡Œê³ , ë§Œê¸° ë„ë˜ ë¬¼ëŸ‰ì´ ì§‘ì¤‘ëœ êµ¬ê°„ì—ì„œ ê°ˆë“±ì´ ì»¤ì§€ê³  ìˆë‹¤.",
  "í•€í…Œí¬ ì—…ê³„ëŠ” ì „ì„¸ ë¦¬ìŠ¤í¬ ì§„ë‹¨ ì„œë¹„ìŠ¤ë¥¼ í™•ëŒ€í•˜ë©° ì„ì°¨ì¸ ëŒ€ìƒ ì‚¬ì „ ì ê²€ ë¦¬í¬íŠ¸ë¥¼ í‘œì¤€í™”í•˜ë ¤ëŠ” ì›€ì§ì„ì„ ë³´ì¸ë‹¤.",
  "í•œí¸ ê°€ê³„ë¶€ì±„ì˜ ì§ˆì  êµ¬ì¡°ê°€ ì•…í™”ëë‹¤ëŠ” ìš°ë ¤ë„ ìˆì–´, ê¸ˆìœµë‹¹êµ­ì€ ìŠ¤íŠ¸ë ˆìŠ¤ DSR ì‹œë®¬ë ˆì´ì…˜ì„ ì •ë¡€í™”í•˜ê² ë‹¤ê³  ë°í˜”ë‹¤.",
  "ë¹„íŠ¸ì½”ì¸ í˜„ë¬¼ ETF ìê¸ˆ ìœ ì…ì´ ì¬ê°œë˜ë©° ë³€ë™ì„±ì´ í™•ëŒ€ëê³ , ì¥ì¤‘ ê³ ì  ëŒíŒŒ ì—¬ë¶€ê°€ ì—°ë§ì¥ì„¸ì˜ ë¶„ìˆ˜ë ¹ì´ ë  ì „ë§ì´ë‹¤.",
  "ëŒ€ì¶œ ê¸ˆë¦¬ ìƒë‹¨ì€ ì œí•œëìœ¼ë‚˜ ê¸°ì¤€ê¸ˆë¦¬ ê²½ë¡œê°€ ë¶ˆí™•ì‹¤í•´ ê³ ì •Â·ë³€ë™ ì¤‘ ì–´ëŠ í•œìª½ì— ë² íŒ…í•˜ê¸°ë³´ë‹¤ í˜¼í•© ì „ëµì´ ìœ ë¦¬í•˜ë‹¤ëŠ” í‰ê°€ë‹¤.",
  "ì„ëŒ€ì¸ì˜ ì±„ë¬´ë¶ˆì´í–‰ ë¦¬ìŠ¤í¬ê°€ í™•ì¸ë  ê²½ìš°, ê³„ì•½ê¸ˆ ë°˜í™˜ íŠ¹ì•½ê³¼ ë‹¨ê³„ë³„ ì•ˆì „ì¥ì¹˜ë¥¼ ë¬¸ì„œë¡œ ë‚¨ê¸°ëŠ” ê²Œ ë¶„ìŸ ì˜ˆë°©ì— íš¨ê³¼ì ì´ë‹¤.",
  "ì§€ë°© ì¤‘ì†Œë„ì‹œì—ì„œëŠ” ì‹ ê·œ ì…ì£¼ ë¬¼ëŸ‰ê³¼ ë¯¸ë¶„ì–‘ ì ì²´ê°€ ë™ì‹œ ë°œìƒí•˜ë©° ì²´ê°ê°€ê²©ì´ í•˜ë°© ì••ë ¥ì„ ë°›ê³  ìˆë‹¤.",
  "ì‹ ê·œ ì²­ë…„ ì „ì„¸ëŒ€ì¶œì€ ë³´ì¦ í•œë„ê°€ ìƒí–¥ëì§€ë§Œ ë³´ì¦ë£Œ ì¸ìƒìœ¼ë¡œ ì‹¤íš¨ì„±ì— ëŒ€í•œ ë…¼ìŸì´ ì´ì–´ì§„ë‹¤.",
  "ë¶€ë™ì‚° ë°ì´í„° í”Œë«í¼ë“¤ì€ êµ¬ë³„ ê±°ë˜ëŸ‰ê³¼ ê°€ê²© ë¶„í¬ë¥¼ ì‹œê°í™”í•˜ë©° ì²´ê³„ì ì¸ ë¹„êµ ë„êµ¬ë¥¼ ì œê³µí•˜ê¸° ì‹œì‘í–ˆë‹¤.",
  "ì •ì±… ë³€ìˆ˜ì™€ ê¸ˆë¦¬ ì—¬ê±´ì´ êµì°¨í•˜ëŠ” êµ­ë©´ì—ì„œ íˆ¬ì íŒë‹¨ì€ ë³´ìˆ˜ì ìœ¼ë¡œ ì ‘ê·¼í•˜ë¼ëŠ” ì¡°ì–¸ì´ í˜ì„ ì–»ëŠ”ë‹¤.",
  "ì „ë¬¸ ë³€í˜¸ì‚¬ë“¤ì€ ë‚´ìš©ì¦ëª…ê³¼ ì¡°ì • ì ˆì°¨ë¥¼ í†µí•´ ì¥ê¸° ì†Œì†¡ìœ¼ë¡œ ë²ˆì§€ëŠ” ì¼ì„ ìµœì†Œí™”í•˜ë¼ê³  ê¶Œí•œë‹¤.",
  "ì „ì„¸ ì‚¬ê¸°ì˜ ì „í˜•ì  íŒ¨í„´ì€ ì¡°ì§ì  ë¸Œë¡œì»¤ ê°œì…ê³¼ í—ˆìœ„ ì‹œì„¸ ì œì‹œ ë“±ìœ¼ë¡œ ë°˜ë³µë˜ë©°, ì˜ˆë°© êµìœ¡ì˜ ì¤‘ìš”ì„±ì´ ì»¤ì§€ê³  ìˆë‹¤.",
  "ìµœê·¼ ë°œí‘œëœ í†µê³„ëŠ” ë³´ì¦ ì‚¬ê³  ê¸ˆì•¡ì´ ì†Œí­ ë‘”í™”ëì§€ë§Œ ì§€ì—­ë³„ í¸ì°¨ê°€ í¬ê²Œ ë²Œì–´ì¡ŒìŒì„ ë³´ì—¬ì¤€ë‹¤.",
  "ì„ì°¨ì¸ ë³´í˜¸ë¥¼ ìœ„í•œ ë””ì§€í„¸ ì„œë¥˜ ê²€ì¦ì´ í™•ì‚°ë˜ë©´ì„œ ê³„ì•½ ê³¼ì •ì˜ íˆ¬ëª…ì„±ì´ ê³¼ê±°ë³´ë‹¤ ë†’ì•„ì¡Œë‹¤ëŠ” í‰ê°€ë„ ìˆë‹¤.",
  "ì‹œì¥ ì°¸ì—¬ìë“¤ì€ ê¸ˆë¦¬ì™€ ê³µê¸‰, ì •ì±… 3ìš”ì†Œê°€ ë™ì‹œì— ì™„í™”ë˜ëŠ” ì‹œì ì„ ì „í™˜ì ìœ¼ë¡œ ë³´ê³  ê´€ë§ì„¸ë¥¼ ìœ ì§€í•˜ëŠ” ë¶„ìœ„ê¸°ë‹¤."
];

const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
function makeParagraph(min=5,max=10){
  const count=randInt(min,max), used=new Set(), out=[];
  while(out.length<count){
    const i=randInt(0,DUMMY_SENTENCES.length-1);
    if(used.has(i)) continue;
    used.add(i); out.push(DUMMY_SENTENCES[i]);
  }
  return out.join(' ');
}

/* ================================
   ìƒíƒœ/ìš”ì†Œ
================================ */
let currentType='news';
const PAGE_SIZE=20, MAX_DOM_CARDS=120, EST_CARD_HEIGHT=470;
let nextCursor=null, reachedEnd=false, loading=false;
let topRemovedCount=0, topSpacerPx=0;

const listEl=document.getElementById('list');
const topSpacer=document.getElementById('topSpacer');
const sentinel=document.getElementById('sentinel');

const pageTitleEl  = document.getElementById('pageTitle');
const viewerTitleEl= document.getElementById('viewerTitle');

/* ì œëª© ë™ê¸°í™” */
function setTitleByType(type){
  const label = (type==='news')? 'ë‰´ìŠ¤' : 'í™ë³´';
  pageTitleEl.textContent = label;
  viewerTitleEl.textContent = label;
  document.title = `${label} â€“ ë¬´í•œìŠ¤í¬ë¡¤Â·ìŠ¬ë¼ì´ë”Â·ë³´ê¸°`;
}
function applyActiveTab(){
  document.querySelectorAll('.tab').forEach(t=>{
    const active = t.dataset.type === currentType;
    t.classList.toggle('is-active', active);
    t.setAttribute('aria-selected', active ? 'true' : 'false');
  });
}

/* ================================
   Tabs
================================ */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    if(tab.classList.contains('is-active'))return;
    document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('is-active');t.setAttribute('aria-selected','false');});
    tab.classList.add('is-active');tab.setAttribute('aria-selected','true');
    currentType=tab.dataset.type;

    setTitleByType(currentType);
    history.replaceState(null, '', `${location.pathname}?type=${currentType}`);

    nextCursor=null; reachedEnd=false; loading=false;
    topRemovedCount=0; topSpacerPx=0; topSpacer.style.height='0';
    listEl.innerHTML='';
    loadNextPage();
  });
});

/* ================================
   Fetch (mock)
================================ */
async function fetchPageFromServer(type,cursor,limit){
  await new Promise(r=>setTimeout(r,200));
  const start=cursor?parseInt(cursor,10):0;
  const end=start+limit;
  const items=[];
  for(let i=start;i<end;i++){
    const id=`${type}-${i}`, seed=`${type}-${i}-${randInt(1,9999)}`;
    items.push({
      id,
      title: makeParagraph(5,10),
      images:[
        `https://picsum.photos/seed/${seed}-1/560/700`,
        `https://picsum.photos/seed/${seed}-2/560/700`,
        `https://picsum.photos/seed/${seed}-3/560/700`,
      ],
      date:new Date(Date.now()-i*86400000).toISOString().slice(0,10)
    });
  }
  const mockTotal=10000;
  return {items,nextCursor:end>=mockTotal?null:String(end)};
}

/* ================================
   Infinite + Virtual Scroll
================================ */
async function loadNextPage(){
  if(loading||reachedEnd) return;
  loading=true;
  try{
    const {items,nextCursor:nc}=await fetchPageFromServer(currentType,nextCursor,PAGE_SIZE);
    nextCursor=nc;
    if(!items||!items.length) reachedEnd=true;
    else{ appendCards(items); if(!nc) reachedEnd=true; }
  } finally{ loading=false; }
}
function appendCards(items){ for(const row of items){listEl.appendChild(buildCard(row));} virtualTrimIfNeeded(); }
function virtualTrimIfNeeded(){
  const cards=listEl.children.length;
  if(cards<=MAX_DOM_CARDS)return;
  const removeCount=Math.min(cards-MAX_DOM_CARDS,Math.floor(MAX_DOM_CARDS/2));
  let removedHeight=0;
  for(let i=0;i<removeCount;i++){
    const first=listEl.firstElementChild; if(!first)break;
    removedHeight+=first.getBoundingClientRect().height||EST_CARD_HEIGHT;
    listEl.removeChild(first); topRemovedCount++;
  }
  topSpacerPx+=removedHeight; topSpacer.style.height=topSpacerPx+'px';
  window.scrollBy(0,-removedHeight);
}
const io=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)loadNextPage();});},{root:null,rootMargin:'800px 0px 800px 0px'});
io.observe(sentinel);

/* ================================
   ë©”ì¸ ì¹´ë“œ
================================ */
function buildCard(row){
  const card=document.createElement('article'); card.className='card';
  const imgs=row.images?.length?row.images:[placeholder()];
  card.innerHTML=`
    <div class="mini-slider" data-index="0">
      <div class="mini-slides"></div>
      <div class="mini-nav">
        <button class="mini-prev" aria-label="ì´ì „">â€¹</button>
        <button class="mini-next" aria-label="ë‹¤ìŒ">â€º</button>
      </div>
    </div>
    <div class="mini-dots"></div>
    <div>
      <div class="caption" tabindex="0" aria-expanded="false"></div>
      <button class="more-btn" type="button">â€¦ ë”ë³´ê¸°</button>
    </div>
    <div class="meta">${row.date}</div>`;
  const cap=card.querySelector('.caption'); cap.textContent=row.title;
  const btn=card.querySelector('.more-btn');
  btn.addEventListener('click',()=>{const expanded=cap.classList.toggle('expanded');cap.setAttribute('aria-expanded',expanded);btn.textContent=expanded?'ì ‘ê¸°':'â€¦ ë”ë³´ê¸°';});
  cap.addEventListener('click',()=>btn.click());
  requestAnimationFrame(()=>{btn.hidden=!(cap.scrollHeight>cap.clientHeight+1);});
  buildMiniSlider(card,imgs,{title:row.title,date:row.date});
  return card;
}

/* ================================
   ë©”ì¸ ìŠ¬ë¼ì´ë”(ìŠ¤ì™€ì´í”„+í´ë¦­ ì˜¤í”ˆ+í‚¤ë³´ë“œ)
================================ */
let activeMiniSlider = null;

function buildMiniSlider(card,srcs,meta){
  const slider=card.querySelector('.mini-slider');
  const slidesEl=card.querySelector('.mini-slides');
  const dotsEl=card.querySelector('.mini-dots');
  slidesEl.innerHTML=''; dotsEl.innerHTML='';

  slider.tabIndex = 0;
  slider.setAttribute('role','group');
  slider.setAttribute('aria-label','ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” (â†/â†’ ì´ë™, Enterë¡œ í¬ê²Œ ë³´ê¸°)');
  slider._imgs = srcs;
  slider._meta = meta;

  ['focusin','pointerdown','mouseenter','touchstart','click']
    .forEach(ev => slider.addEventListener(ev, ()=>{ activeMiniSlider = slider; }));

  srcs.forEach((src,i)=>{
    const s=document.createElement('div'); s.className='mini-slide';
    const img=new Image(); img.src=src; img.alt=`ì´ë¯¸ì§€ ${i+1}`; img.setAttribute('draggable','false');
    s.appendChild(img); slidesEl.appendChild(s);
    const d=document.createElement('div'); d.className='mini-dot'; d.addEventListener('click',()=>goTo(slider,i)); dotsEl.appendChild(d);
  });

  card.querySelector('.mini-prev').addEventListener('click',()=>goStep(slider,-1));
  card.querySelector('.mini-next').addEventListener('click',()=>goStep(slider,+1));

  let startX=null, startY=null, swiped=false, hLock=false;
  slider.addEventListener('touchstart', e=>{
    const t=e.touches[0]; startX=t.clientX; startY=t.clientY; swiped=false; hLock=false;
  }, {passive:true});
  slider.addEventListener('touchmove', e=>{
    if(startX==null) return;
    const t=e.touches[0], dx=t.clientX-startX, dy=t.clientY-startY;
    if(!hLock && (Math.abs(dx)>8 || Math.abs(dy)>8)){ hLock=Math.abs(dx)>Math.abs(dy); }
    if(hLock && e.cancelable) e.preventDefault();
  }, {passive:false});
  slider.addEventListener('touchend', e=>{
    if(startX==null) return;
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)>40){ swiped=true; dx<0?goStep(slider,+1):goStep(slider,-1); }
    startX=startY=null;
  }, {passive:true});

  slider.addEventListener('click', (e)=>{
    if (e.target.closest('button') || e.target.closest('.mini-dots')) return;
    if(swiped){ swiped=false; return; }
    openViewer(srcs, meta?.title || '', meta?.date || '');
  });

  setIndex(slider,0);
}
function setIndex(slider,i){
  const slidesEl=slider.querySelector('.mini-slides');
  const total=slidesEl.children.length;
  const idx=Math.max(0,Math.min(total-1,i));
  slider.dataset.index=String(idx);
  slidesEl.style.transform=`translateX(${-idx*100}%)`;
  const dots=slider.parentElement.querySelectorAll('.mini-dot');
  dots.forEach((d,k)=>d.classList.toggle('active',k===idx));
}
const goTo=(slider,i)=>setIndex(slider,i);
const goStep=(slider,step)=>setIndex(slider,(+slider.dataset.index||0)+step);

/* ================================
   ì „ì—­ í‚¤ë³´ë“œ(ë©”ì¸ ìŠ¬ë¼ì´ë”ìš©)
================================ */
function getSliderInView(){
  const sliders = [...document.querySelectorAll('.mini-slider')];
  const mid = window.innerHeight/2;
  let best = null, bestDist = Infinity;
  for(const s of sliders){
    const r = s.getBoundingClientRect();
    if (r.bottom < 0 || r.top > window.innerHeight) continue;
    const d = Math.abs((r.top + r.height/2) - mid);
    if (d < bestDist){ best = s; bestDist = d; }
  }
  return best;
}
document.addEventListener('keydown', (e)=>{
  if (viewer && viewer.style.display === 'block') return;

  const target = activeMiniSlider || getSliderInView();
  if (!target) return;

  if (e.key === 'ArrowRight'){
    goStep(target, +1); e.preventDefault();
  } else if (e.key === 'ArrowLeft'){
    goStep(target, -1); e.preventDefault();
  } else if (e.key === 'Home'){
    goTo(target, 0); e.preventDefault();
  } else if (e.key === 'End'){
    const slides = target.querySelector('.mini-slides');
    goTo(target, slides.children.length - 1); e.preventDefault();
  } else if (e.key === 'Enter' || e.key === ' '){
    openViewer(target._imgs, target._meta?.title || '', target._meta?.date || '');
    e.preventDefault();
  }
});

/* ================================
   Viewer (ë‹«ê¸°/ë‚´ë¹„/ê³µìœ )
================================ */
const viewer      = document.getElementById('viewer');
const backdrop    = document.getElementById('viewer-backdrop');
const vSlidesEl   = document.getElementById('viewerSlides');
const vDotsEl     = document.getElementById('viewerDots');
const vCaptionEl  = document.getElementById('viewerCaption');
const vDateEl     = document.getElementById('viewerDate');
const vPrevBtn    = document.getElementById('viewerPrev');
const vNextBtn    = document.getElementById('viewerNext');
const vCloseBtn   = document.getElementById('viewerCloseBtn');
const vListBtn    = document.getElementById('viewerListBtn');
const vShareBtn   = document.getElementById('viewerShareBtn');
const vPlayBtn    = document.getElementById('viewerPlayBtn');
const vSliderBox  = document.getElementById('viewerSlider');

let vIdx = 0;

/* Zoom state (ì´ë¯¸ì§€ ì¤Œ/íŒ¬) */
let zScale = 1, zTx = 0, zTy = 0;
const Z_MIN = 1, Z_MAX = 4;
let pinchStartDist = 0, pinchStartScale = 1;
let panStartX = 0, panStartY = 0, panStartTx = 0, panStartTy = 0;
let isPanning = false, isPinching = false;
let suppressTapClose = false;
function blockTapCloseBrief(){ suppressTapClose = true; setTimeout(()=>{ suppressTapClose = false; }, 250); }

function viewerImgEl(){ const slide = vSlidesEl.children[vIdx]; return slide ? slide.querySelector('img') : null; }
function resetZoom(){
  zScale = 1; zTx = 0; zTy = 0;
  const img = viewerImgEl(); if(!img) return;
  img.style.transform = `translate(0px,0px) scale(1)`;
  vSliderBox.classList.remove('is-zoomed','is-panning');
}
function applyZoom(){
  const img = viewerImgEl(); if(!img) return;
  img.style.transform = `translate(${zTx}px,${zTy}px) scale(${zScale})`;
  if (zScale > 1) vSliderBox.classList.add('is-zoomed');
  else vSliderBox.classList.remove('is-zoomed','is-panning');
}
function clampPan(){
  const boxW = vSliderBox.clientWidth;
  const boxH = vSliderBox.clientHeight;
  const maxX = (boxW * (zScale - 1)) / 2;
  const maxY = (boxH * (zScale - 1)) / 2;
  zTx = Math.max(-maxX, Math.min(maxX, zTx));
  zTy = Math.max(-maxY, Math.min(maxY, zTy));
}

function openViewer(imgs, caption, date){
  vSlidesEl.innerHTML = '';
  vDotsEl.innerHTML = '';
  imgs.forEach((src, i)=>{
    const s = document.createElement('div');
    s.className = 'viewer-slide';
    s.innerHTML = `<img src="${src}" alt="ì´ë¯¸ì§€ ${i+1}">`;
    vSlidesEl.appendChild(s);

    const d = document.createElement('div');
    d.className = 'viewer-dot';
    d.addEventListener('click', (e)=>{ e.stopPropagation(); viewerGoTo(i); });
    vDotsEl.appendChild(d);
  });

  // âœ¨ ìº¡ì…˜ì„ ë¬¸ì¥(ì‘ì€ ë‹¨ë½) ë‹¨ìœ„ë¡œ ë Œë”
  renderCaptionAsSegments(caption || '');
  vDateEl.textContent = date || '';

  vIdx = 0; viewerUpdate();
  resetZoom();

  viewer.style.display='block';
  backdrop.style.display='block';
  viewer.setAttribute('aria-hidden','false');
  document.addEventListener('keydown', escCloseOnce);
  document.body.classList.add('no-scroll');

  stopAllReadingImmediately(); // ìƒˆë¡œ ì—´ë©´ TTS ìƒíƒœ ì´ˆê¸°í™”
}
function closeViewer(){
  stopAllReadingImmediately(); // ì™„ì „ ì¢…ë£Œ(í•˜ì´ë¼ì´íŠ¸ ì œê±°)
  viewer.style.display='none';
  backdrop.style.display='none';
  viewer.setAttribute('aria-hidden','true');
  document.removeEventListener('keydown', escCloseOnce);
  document.body.classList.remove('no-scroll');
}
function escCloseOnce(e){
  if(e.key==='Escape') closeViewer();
  if(e.key==='ArrowLeft') viewerStep(-1);
  if(e.key==='ArrowRight') viewerStep(+1);
}
function viewerGoTo(i){
  const total = vSlidesEl.children.length;
  vIdx = Math.max(0, Math.min(total-1, i));
  viewerUpdate();
  resetZoom();
}
function viewerStep(step){ viewerGoTo(vIdx + step); }
function viewerUpdate(){
  vSlidesEl.style.transform = `translateX(${-vIdx*100}%)`;
  [...vDotsEl.children].forEach((d,i)=> d.classList.toggle('active', i===vIdx));
  vPrevBtn.disabled = (vIdx===0);
  const total = vSlidesEl.children.length;
  vNextBtn.disabled = (vIdx===total-1);
}

/* ================================
   Share
================================ */
async function shareCurrent(){
  const img = viewerImgEl(); if(!img) return;

  const pageUrl = location.href;
  const imgUrl  = img.src;
  const title   = (pageTitleEl?.textContent || 'ë‰´ìŠ¤&í™ë³´');
  const text    = [vCaptionEl.textContent||'', vDateEl.textContent||'', pageUrl].filter(Boolean).join('\n');

  // ì•ˆë“œë¡œì´ë“œì—ì„œ ì¹´í†¡ìœ¼ë¡œ í…ìŠ¤íŠ¸ê¹Œì§€ ë³´ë‚´ë ¤ë©´ ë§í¬ ê³µìœ ë¥¼ ê¶Œì¥
  const isAndroid = /Android/i.test(navigator.userAgent);
  let preferLink = false;

  if (isAndroid) {
    preferLink = confirm(
      'ì¹´ì¹´ì˜¤í†¡ì— í…ìŠ¤íŠ¸/URLê¹Œì§€ ë³´ë‚´ì‹œë ¤ë©´ "í™•ì¸"ì„ ëˆŒëŸ¬ ë§í¬ ê³µìœ ë¡œ ì „ì†¡í•˜ì„¸ìš”.\n' +
      'ì´ë¯¸ì§€ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ë³´ë‚´ë ¤ë©´ "ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ì„¸ìš”.'
    );
  }

  vShareBtn.disabled = true;
  const prev = vShareBtn.textContent;
  vShareBtn.textContent = 'ê³µìœ  ì¤€ë¹„ ì¤‘â€¦';

  try{
    if (preferLink || !('canShare' in navigator)) {
      // ë§í¬(í…ìŠ¤íŠ¸+URL) ê³µìœ  â€” ì¹´í†¡ ê¶Œì¥ ê²½ë¡œ
      if (navigator.share) {
        await navigator.share({ title, text, url: pageUrl });
      } else if (navigator.clipboard) {
        await navigator.clipboard.writeText(`${text}\n${imgUrl}`);
        alert('í…ìŠ¤íŠ¸ì™€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', `${text}\n${imgUrl}`);
      }
      return;
    }

    // íŒŒì¼ ê³µìœ  (ë‹¤ìˆ˜ ì•±ì—ì„œ í…ìŠ¤íŠ¸/URLì´ ë¬´ì‹œë  ìˆ˜ ìˆìŒ)
    let file = null;
    try{
      const res  = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
      const blob = await res.blob();
      const mime = blob.type || 'image/jpeg';
      const ext  = (mime.split('/')[1] || 'jpg').replace('jpeg','jpg');
      file = new File([blob], `image.${ext}`, { type: mime });
    }catch(_){}

    if (file && navigator.canShare({ files:[file] })) {
      // ì¼ë¶€ ì•±(íŠ¹íˆ ì¹´í†¡)ì—ì„œ text/urlì„ ë¬´ì‹œí•  ìˆ˜ ìˆìŒ
      await navigator.share({ title, text, url: pageUrl, files:[file] });
    } else if (navigator.share) {
      await navigator.share({ title, text, url: pageUrl });
    } else if (navigator.clipboard) {
      await navigator.clipboard.writeText(`${text}\n${imgUrl}`);
      alert('í…ìŠ¤íŠ¸ì™€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', `${text}\n${imgUrl}`);
    }
  }catch(e){
    // í´ë°±: ìµœì†Œí•œ í…ìŠ¤íŠ¸/ë§í¬ëŠ” ë„˜ê¸°ê¸°
    try{
      if (navigator.clipboard) {
        await navigator.clipboard.writeText(`${text}\n${imgUrl}`);
        alert('í…ìŠ¤íŠ¸ì™€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', `${text}\n${imgUrl}`);
      }
    }catch(_){}
  }finally{
    vShareBtn.disabled = false;
    vShareBtn.textContent = prev;
  }
}

/* ================================
   âœ¨ TTS: ë¬¸ì¥(ì‘ì€ ë‹¨ë½) ë‹¨ìœ„ ì½ê¸° + í˜•ê´‘íœ
================================ */
let ttsEnabled = false;   // ì½ê¸° ì¤‘ì¸ì§€
let isPaused   = false;   // ì¼ì‹œì •ì§€ ì—¬ë¶€(í˜•ê´‘íœ ìœ ì§€)
let ttsVoice   = null;

let captionSegNodes = []; // span ë¦¬ìŠ¤íŠ¸
let captionSegIndex = 0;  // í˜„ì¬(í˜¹ì€ ë§ˆì§€ë§‰ ê°•ì¡°) ì¸ë±ìŠ¤
let ttsCurrentUtter = null;

function pickKoVoice(){
  if (!('speechSynthesis' in window)) return;
  const voices = speechSynthesis.getVoices();
  ttsVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('ko'))
          || voices.find(v => /korean|í•œêµ­ì–´/i.test(v.name))
          || voices[0] || null;
}
if ('speechSynthesis' in window) {
  pickKoVoice();
  window.speechSynthesis.addEventListener('voiceschanged', pickKoVoice);
}

/* ë¬¸ì¥(ì‘ì€ ë‹¨ë½) ë¶„í• : ì¢…ê²°ë¶€í˜¸/ì¢…ê²°ì–´ë¯¸ ê¸°ì¤€ + ê¸´ ë¬¸ì¥ì€ 50~60ìì¯¤ìœ¼ë¡œ ì¶”ê°€ ë¶„í•  */
function splitSentencesKorean(text) {
  if (!text) return [];
  const trimmed = text.replace(/\s+/g, ' ').trim();
  const roughParts = trimmed.split(/[\n\r]+|[â€¢Â·â–ªâ—â€£â—¦]+/).map(s => s.trim()).filter(Boolean);
  const out = [];
  const re = /(.+?(?:[\.!?â€¦]+|(?:ë‹¤|ìš”|ìŠµë‹ˆë‹¤|ìŠµë‹ˆê¹Œ|ë„¤ìš”|êµ°ìš”|ëë‹ˆë‹¤|ì˜€ë‹¤|ëœë‹¤|í–ˆë‹¤|ì¼ê¹Œ|ì¼ê¹Œìš”|ì¼ ìˆ˜ë„ ìˆë‹¤|ì¼ìˆ˜ë„ ìˆë‹¤)\s*(?:ìš”)?)(?=\s|$)|.+?$)/g;
  for (const part of roughParts) {
    const segs = part.match(re) || [];
    for (let seg of segs) {
      seg = seg.trim(); if (!seg) continue;
      if (seg.length > 70) {
        const chunks = seg.match(/.{1,55}(?:\s|$)/g) || [seg];
        chunks.forEach(c => out.push(c.trim()));
      } else {
        out.push(seg);
      }
    }
  }
  return out;
}

/* ìº¡ì…˜ì„ span.segë“¤ë¡œ ë Œë” + í´ë¦­ ì‹œ í•´ë‹¹ ë¬¸ì¥ë¶€í„° ì½ê¸° */
function renderCaptionAsSegments(text) {
  captionSegNodes = [];
  captionSegIndex = 0;
  vCaptionEl.innerHTML = '';
  const segs = splitSentencesKorean(text);
  if (segs.length === 0) return;

  const frag = document.createDocumentFragment();
  segs.forEach((s, i) => {
    const span = document.createElement('span');
    span.className = 'seg';
    span.textContent = s;
    span.addEventListener('click', (e)=>{
      e.stopPropagation();
      if (!('speechSynthesis' in window)) { alert('ë¸Œë¼ìš°ì €ê°€ ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      isPaused = false;
      ttsEnabled = true;
      startSegmentTTS(i);
    });
    frag.appendChild(span);
    if (i !== segs.length - 1) frag.appendChild(document.createTextNode(' '));
    captionSegNodes.push(span);
  });
  vCaptionEl.appendChild(frag);
}

/* í˜„ì¬ ë¬¸ì¥ í˜•ê´‘íœ í† ê¸€ + ê°€ì‹œì„± ìœ ì§€ */
function paintCurrentSegment(idx) {
  captionSegNodes.forEach((n, k) => n.classList.toggle('is-reading', k === idx));
  const node = captionSegNodes[idx];
  if (node) {
    const rect = node.getBoundingClientRect();
    const box = vCaptionEl.getBoundingClientRect();
    if (rect.top < box.top || rect.bottom > box.bottom + 60) {
      node.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
  }
}

function speakOneSentence(text, onend) {
  const u = new SpeechSynthesisUtterance(text);
  if (ttsVoice) u.voice = ttsVoice;
  u.lang  = ttsVoice?.lang || 'ko-KR';
  u.rate  = 1.0;
  u.pitch = 1.0;
  u.onend = () => { ttsCurrentUtter = null; onend && onend(); };
  u.onerror= () => { ttsCurrentUtter = null; onend && onend(); };
  ttsCurrentUtter = u;
  speechSynthesis.speak(u);
}

function startSegmentTTS(startIdx = captionSegIndex || 0) {
  if (!('speechSynthesis' in window)) { alert('ë¸Œë¼ìš°ì €ê°€ ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  if (!captionSegNodes.length) return;

  captionSegIndex = Math.max(0, Math.min(captionSegNodes.length - 1, startIdx));
  ttsEnabled = true;
  isPaused   = false;
  vPlayBtn.textContent = 'ì¼ì‹œì •ì§€';

  function step() {
    if (!ttsEnabled || isPaused) return;
    const span = captionSegNodes[captionSegIndex];
    if (!span) { finishReadingUI(); return; }
    paintCurrentSegment(captionSegIndex);
    const text = span.textContent.trim();
    speakOneSentence(text, () => {
      if (!ttsEnabled || isPaused) return;
      captionSegIndex++;
      if (captionSegIndex >= captionSegNodes.length) {
        finishReadingUI();
      } else {
        step();
      }
    });
  }

  try { speechSynthesis.cancel(); } catch(_) {}
  step();
}

/* ì¼ì‹œì •ì§€: ìŒì„±ë§Œ ë©ˆì¶”ê³  í•˜ì´ë¼ì´íŠ¸ëŠ” ìœ ì§€ */
function pauseSegmentTTS() {
  isPaused = true;
  try { speechSynthesis.cancel(); } catch(_){}
  vPlayBtn.textContent = 'ì¬ìƒ';
}

/* ëª¨ë‘ ëë‚¬ì„ ë•Œ UI ì •ë¦¬(í•˜ì´ë¼ì´íŠ¸ ì œê±°) */
function finishReadingUI() {
  ttsEnabled = false;
  isPaused   = false;
  vPlayBtn.textContent = 'ì¬ìƒ';
  captionSegNodes.forEach(n => n.classList.remove('is-reading'));
}

/* ë‹«ê¸° ë“±ì—ì„œ ì™„ì „ ì¢…ë£Œ */
function stopAllReadingImmediately() {
  ttsEnabled = false;
  isPaused   = false;
  try { speechSynthesis.cancel(); } catch(_){}
  vPlayBtn.textContent = 'ì¬ìƒ';
  captionSegNodes.forEach(n => n.classList.remove('is-reading'));
}

/* ì¬ìƒ ë²„íŠ¼: í† ê¸€ (ì¬ìƒ â†” ì¼ì‹œì •ì§€) */
vPlayBtn.addEventListener('click', ()=>{
  if (!('speechSynthesis' in window)) { alert('ë¸Œë¼ìš°ì €ê°€ ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  if (ttsEnabled && !isPaused) { // ì½ëŠ” ì¤‘ â†’ ì¼ì‹œì •ì§€
    pauseSegmentTTS();
  } else { // (ì¬)ìƒ
    startSegmentTTS(captionSegIndex || 0);
  }
});

/* ë‹«í˜/ë²„íŠ¼ ì´ë²¤íŠ¸ */
[vPrevBtn, vNextBtn, vCloseBtn, vListBtn, vShareBtn].forEach(btn=>{
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); });
});
vPrevBtn.addEventListener('click', ()=> viewerStep(-1));
vNextBtn.addEventListener('click', ()=> viewerStep(+1));
vCloseBtn.addEventListener('click', closeViewer);
vListBtn .addEventListener('click', closeViewer);
vShareBtn.addEventListener('click', shareCurrent);

/* Viewer ìŠ¤ì™€ì´í”„(í™•ëŒ€ ì•ˆí–ˆì„ ë•Œ) */
let vStartX=null, vStartY=null, vHLock=false;
vSlidesEl.addEventListener('touchstart', e=>{
  if (e.touches.length===1 && zScale===1){
    vStartX=e.touches[0].clientX; vStartY=e.touches[0].clientY; vHLock=false;
  }
},{passive:true});
vSlidesEl.addEventListener('touchmove', e=>{
  if (zScale!==1 || vStartX==null) return;
  const dx=e.touches[0].clientX-vStartX;
  const dy=e.touches[0].clientY-vStartY;
  if(!vHLock && (Math.abs(dx)>8 || Math.abs(dy)>8)){ vHLock=Math.abs(dx)>Math.abs(dy); }
  if(vHLock) e.preventDefault();
},{passive:false});
vSlidesEl.addEventListener('touchend', e=>{
  if (vStartX==null || zScale!==1) return;
  const dx=e.changedTouches[0].clientX-vStartX;
  if(Math.abs(dx)>40) dx<0 ? viewerStep(+1) : viewerStep(-1);
  vStartX=vStartY=null; vHLock=false;
  blockTapCloseBrief();
},{passive:true});

/* Pinch Zoom + Pan (í„°ì¹˜) */
vSlidesEl.addEventListener('touchstart', (e)=>{
  if (e.touches.length===2){
    isPinching = true; isPanning=false;
    pinchStartDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    pinchStartScale = zScale;
  } else if (e.touches.length===1 && zScale>1){
    isPanning = true; isPinching=false;
    panStartX = e.touches[0].clientX; panStartY = e.touches[0].clientY;
    panStartTx = zTx; panStartTy = zTy;
    vSliderBox.classList.add('is-panning');
  }
},{passive:false});
vSlidesEl.addEventListener('touchmove', (e)=>{
  if (isPinching && e.touches.length===2){
    e.preventDefault();
    const dist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    zScale = Math.max(Z_MIN, Math.min(Z_MAX, (dist/pinchStartDist) * pinchStartScale));
    clampPan(); applyZoom();
  } else if (isPanning && e.touches.length===1){
    e.preventDefault();
    const dx = e.touches[0].clientX - panStartX;
    const dy = e.touches[0].clientY - panStartY;
    zTx = panStartTx + dx;
    zTy = panStartTy + dy;
    clampPan(); applyZoom();
  }
},{passive:false});
vSlidesEl.addEventListener('touchend', ()=>{
  if (isPinching || isPanning){
    isPinching = false; isPanning = false;
    vSliderBox.classList.remove('is-panning');
    blockTapCloseBrief();
  }
});

/* ë§ˆìš°ìŠ¤ íœ  ì¤Œ(ë°ìŠ¤í¬í†±: Ctrl + íœ ) */
vSlidesEl.addEventListener('wheel', (e)=>{
  if(!e.ctrlKey) return;
  e.preventDefault();
  const delta = -e.deltaY;
  const factor = delta>0 ? 1.05 : 0.95;
  zScale = Math.max(Z_MIN, Math.min(Z_MAX, zScale * factor));
  clampPan(); applyZoom();
},{passive:false});

/* ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ íŒ¬ */
vSlidesEl.addEventListener('mousedown', (e)=>{
  if (zScale<=1 || e.button!==0) return;
  isPanning = true; isPinching = false;
  panStartX = e.clientX; panStartY = e.clientY;
  panStartTx = zTx; panStartTy = zTy;
  vSliderBox.classList.add('is-panning');
  e.preventDefault();
});
window.addEventListener('mousemove', (e)=>{
  if (!isPanning) return;
  const dx = e.clientX - panStartX;
  const dy = e.clientY - panStartY;
  zTx = panStartTx + dx;
  zTy = panStartTy + dy;
  clampPan(); applyZoom();
});
window.addEventListener('mouseup', ()=>{
  if (isPanning){ isPanning=false; vSliderBox.classList.remove('is-panning'); }
});

/* Helper */
function placeholder(){
  return "data:image/svg+xml;utf8,"+encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='560' height='700'>
      <rect width='100%' height='100%' rx='12' fill='#dddddd'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#333' font-size='28'>280Ã—350</text>
    </svg>`
  );
}

/* ì´ˆê¸° ë¡œë“œ */
{
  const urlType = new URLSearchParams(location.search).get('type');
  if (urlType === 'news' || urlType === 'pr') currentType = urlType;
  applyActiveTab();
  setTitleByType(currentType);
  loadNextPage();
}
</script>
</body>
</html>
