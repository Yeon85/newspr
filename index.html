<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë‰´ìŠ¤ â€“ ë¬´í•œìŠ¤í¬ë¡¤Â·ìŠ¬ë¼ì´ë”Â·ë³´ê¸°</title>
<style>
  :root{ --bg:#f5f6f8; --card:#fff; --ink:#222; --ink2:#666; --line:#e9e9ee; --brand:#0b5bd3; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink)}
  body.no-scroll{ overflow:hidden; }

  /* Header */
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
  .bar{max-width:520px;margin:0 auto;display:flex;align-items:center;gap:8px;padding:10px 12px}
  .chip{min-width:34px;height:34px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;background:#fff;text-decoration:none;color:inherit}
  .title{font-weight:700;margin-left:6px}
  .bar-right{margin-left:auto;display:flex;gap:8px}

  /* Tabs */
  .tabs{max-width:520px;margin:0 auto;display:flex;gap:10px;padding:10px 12px 6px;background:#fff;position:sticky;top:56px;z-index:19;border-bottom:1px solid var(--line)}
  .tab{padding:7px 14px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:14px;cursor:pointer}
  .tab.is-active{background:var(--brand);border-color:var(--brand);color:#fff}

  /* Page */
  .wrap{max-width:520px;margin:0 auto;padding:10px 12px 40px}
  #topSpacer,#bottomSpacer{height:0}
  .list{display:block}
  .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;margin-bottom:14px}

  /* ===== ë©”ì¸ ì¹´ë“œ ìŠ¬ë¼ì´ë” ===== */
  .mini-slider{
    position:relative;border-radius:12px;overflow:hidden;background:#ddd;
    overscroll-behavior:contain;
  }
  .mini-slides{display:flex;transition:transform .35s ease}
  .mini-slide{min-width:100%}
  .mini-slide img{
    display:block;width:100%;aspect-ratio:4/5;object-fit:cover;  /* 280Ã—350 ë¹„ìœ¨ */
    cursor:pointer;-webkit-user-drag:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;
  }
  /* iOS/Android ì•ˆì •í™”: ê°€ë¡œ ìŠ¤ì™€ì´í”„ ì¤‘ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì–µì œ(ì„¸ë¡œë§Œ í—ˆìš©) */
  .mini-slider, .mini-slides, .mini-slide, .mini-slide img { touch-action: pan-y; }

  /* â€¹ â€º : ë‘ ë²ˆì§¸ ì¥ë¶€í„° ë³´ì´ê¸° */
  .mini-nav{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none;opacity:0;transition:opacity .2s}
  .mini-nav button{pointer-events:auto;border:none;background:rgba(0,0,0,.35);color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer}
  .mini-slider.show-nav .mini-nav{opacity:1}

  .mini-dots{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px 0 6px}
  .mini-dot{width:8px;height:8px;border-radius:50%;background:#cfd3da;cursor:pointer}
  .mini-dot.active{background:var(--brand)}

  /* Caption 1ì¤„ + ë”ë³´ê¸° */
  .caption{margin-top:2px;font-size:14px;line-height:1.55;color:#222;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;overflow:hidden}
  .caption.expanded{-webkit-line-clamp:unset;display:block}
  .more-btn{display:inline-flex;gap:4px;align-items:center;margin-top:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#333;cursor:pointer}
  .more-btn[hidden]{display:none!important}
  .meta{display:flex;justify-content:flex-end;color:#666;font-size:12px;margin-top:6px}

  .sentinel{height:24px}

  /* ===== íŒì—…(ë·°ì–´) ===== */
  .viewer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999;}
  .viewer{position:fixed;inset:0;display:none;z-index:1000;overflow:auto;overscroll-behavior:contain}
  .viewer .sheet{max-width:520px;margin:20px auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.2);padding:14px}
  .viewer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .viewer-title{font-weight:700}
  .viewer-close{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}

  .viewer-slider{position:relative;border-radius:12px;overflow:hidden;background:#ddd;overscroll-behavior:contain}
  .viewer-slides{display:flex;transition:transform .35s ease}
  .viewer-slide{min-width:100%}
  .viewer-slide img{
    display:block;width:100%;aspect-ratio:4/5;object-fit:cover;
    touch-action:none; transform-origin:center center; will-change: transform;
    cursor:pointer;-webkit-user-drag:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;
  }
  .viewer-dots{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px 0 6px}
  .viewer-dot{width:8px;height:8px;border-radius:50%;background:#cfd3da;cursor:pointer}
  .viewer-dot.active{background:var(--brand)}
  .viewer-nav{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%)}
  .viewer-nav button{border:none;background:rgba(0,0,0,.35);color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer}

  .viewer-caption{margin-top:8px;font-size:14px;line-height:1.6;color:#222}
  .viewer-meta{display:flex;justify-content:flex-end;color:#666;font-size:12px;margin-top:8px}
  .viewer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .viewer-actions .ghost{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
  .viewer-actions .primary{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}

  /* í™•ëŒ€ ì¤‘ ì»¤ì„œ í”¼ë“œë°± */
  #viewerSlider.is-zoomed  .viewer-slide img { cursor: grab; }
  #viewerSlider.is-zoomed.is-panning .viewer-slide img { cursor: grabbing; }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="chip" aria-label="ë’¤ë¡œ">â†</div>
      <div class="title" id="pageTitle">ë‰´ìŠ¤</div>
      <div class="bar-right">
        <a class="chip" aria-label="í™ˆ" href="https://www.khug.or.kr/index.jsp">ğŸ </a>
        <div class="chip" aria-label="ë©”ë‰´">â‰¡</div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="ë‰´ìŠ¤/í™ë³´">
    <button class="tab is-active" data-type="news" aria-selected="true">ë‰´ìŠ¤</button>
    <button class="tab" data-type="pr" aria-selected="false">í™ë³´</button>
  </div>

  <main class="wrap">
    <div id="topSpacer"></div>
    <section id="list" class="list"></section>
    <div id="bottomSpacer"></div>
    <div id="sentinel" class="sentinel" aria-hidden="true"></div>
  </main>

  <!-- ====== Viewer ====== -->
  <div id="viewer-backdrop" class="viewer-backdrop"></div>
  <div id="viewer" class="viewer" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="sheet">
      <div class="viewer-header">
        <div class="viewer-title" id="viewerTitle">ë‰´ìŠ¤</div>
        <button class="viewer-close" id="viewerCloseBtn" type="button">ë‹«ê¸°</button>
      </div>

      <div class="viewer-slider" data-index="0" id="viewerSlider">
        <div class="viewer-slides" id="viewerSlides"></div>
        <div class="viewer-nav">
          <button id="viewerPrev">â€¹</button>
          <button id="viewerNext">â€º</button>
        </div>
      </div>
      <div class="viewer-dots" id="viewerDots"></div>

      <div class="viewer-caption" id="viewerCaption"></div>
      <div class="viewer-meta" id="viewerDate"></div>

      <div class="viewer-actions">
        <button class="ghost"   id="viewerShareBtn"  type="button">ê³µìœ </button>
        <button class="ghost"   id="viewerPlayBtn"   type="button">ì¬ìƒ</button>
        <button class="primary" id="viewerListBtn"   type="button">ëª©ë¡</button>
      </div>
    </div>
  </div>

<script>
/* ================================
   ìƒìˆ˜/ìœ í‹¸/ê°€ë“œ
================================ */
const PAGE_SIZE=20, MAX_DOM_CARDS=120, EST_CARD_HEIGHT=470;
const MAX_IMAGES = 10;                 // ì‚¬ì§„ ìµœëŒ€ 10ì¥
const USE_POINTER = !!window.PointerEvent;

/* ê³ ìŠ¤íŠ¸ í´ë¦­/ì¤‘ë³µ ì˜¤í”ˆ/ì¦‰ì‹œ ë‹«í˜ ê°€ë“œ */
const OPEN_GUARD_MS  = 350;
let lastOpenTs  = 0, lastCloseTs = 0;
function canOpenNow(){
  const now = Date.now();
  return (now - lastOpenTs > OPEN_GUARD_MS) && (now - lastCloseTs > 120);
}
function noteClosed(){ lastCloseTs = Date.now(); }
function justOpenedShield(){
  lastOpenTs = Date.now();
  const swallow=(ev)=>{ ev.stopPropagation(); ev.preventDefault(); cleanup(); };
  const cleanup = ()=> document.removeEventListener('click', swallow, true);
  document.addEventListener('click', swallow, true);
  setTimeout(cleanup, OPEN_GUARD_MS);
}

const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

/* ê¸´ ë”ë¯¸ ë¬¸ì¥ë“¤ */
const DUMMY_SENTENCES = [
  "ì „ì„¸ë³´ì¦ê¸ˆ ë°˜í™˜ì„ ë‘˜ëŸ¬ì‹¼ ë¶„ìŸì´ ì´ì–´ì§€ë©´ì„œ ì„ì°¨ì¸ì˜ ì •ë³´ ë¹„ëŒ€ì¹­ í•´ì†Œê°€ ì‹œê¸‰í•˜ë‹¤ëŠ” ì§€ì ì´ ë‚˜ì˜¨ë‹¤.",
  "ì •ë¶€ëŠ” ì„ëŒ€ì°¨ ì‹ ê³ ì œ ë³´ì™„ê³¼ ë³´ì¦ ë³´í—˜ ì˜ë¬´í™” í™•ëŒ€ë¥¼ ì˜ˆê³ í–ˆì§€ë§Œ í˜„ì¥ì˜ ì²´ê°ë„ëŠ” ì—¬ì „íˆ ë‚®ë‹¤.",
  "ì „ë¬¸ê°€ë“¤ì€ ê³„ì•½ ì „ ë‹¨ê³„ì—ì„œ ë“±ê¸°ë¶€ í™•ì¸ê³¼ í™•ì •ì¼ì, ì „ì…ì‹ ê³ ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜ ë³´ì¦ì´ë ¥ê³¼ ì²´ë‚©ì •ë³´ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ì‚´í”¼ë¼ê³  ì¡°ì–¸í•œë‹¤.",
  "ê¸€ë¡œë²Œ ê¸ˆìœµì‹œì¥ì€ ë¯¸ ì—°ì¤€ì˜ ê¸ˆë¦¬ ì¸í•˜ ì‹œì ì„ ë†“ê³  í˜¼ì¡°ì„¸ë¥¼ ë³´ì´ëŠ” ê°€ìš´ë° ìœ„í—˜ìì‚° ì„ í˜¸ê°€ ì¼ì‹œì ìœ¼ë¡œ íšŒë³µë˜ëŠ” ëª¨ìŠµì´ë‹¤.",
  "êµ­ë‚´ ì£¼íƒë‹´ë³´ëŒ€ì¶œ ê¸ˆë¦¬ëŠ” ë³€ë™í­ì´ ì»¤ì¡Œê³ , ì¤‘ë„ìƒí™˜ ìˆ˜ìˆ˜ë£Œ ë©´ì œ ê¸°ê°„ì„ í™œìš©í•´ì•¼ ì´ì ë¶€ë‹´ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.",
  "ì¼ë¶€ ì§€ì—­ì€ ì—­ì „ì„¸ê°€ ì‹¬í™”ë˜ë©° ê¹¡í†µì „ì„¸ ìš°ë ¤ê°€ ë†’ì•„ì¡Œê³ , ë§Œê¸° ë„ë˜ ë¬¼ëŸ‰ì´ ì§‘ì¤‘ëœ êµ¬ê°„ì—ì„œ ê°ˆë“±ì´ ì»¤ì§€ê³  ìˆë‹¤.",
  "í•€í…Œí¬ ì—…ê³„ëŠ” ì „ì„¸ ë¦¬ìŠ¤í¬ ì§„ë‹¨ ì„œë¹„ìŠ¤ë¥¼ í™•ëŒ€í•˜ë©° ì„ì°¨ì¸ ëŒ€ìƒ ì‚¬ì „ ì ê²€ ë¦¬í¬íŠ¸ë¥¼ í‘œì¤€í™”í•˜ë ¤ëŠ” ì›€ì§ì„ì„ ë³´ì¸ë‹¤.",
  "í•œí¸ ê°€ê³„ë¶€ì±„ì˜ ì§ˆì  êµ¬ì¡°ê°€ ì•…í™”ëë‹¤ëŠ” ìš°ë ¤ë„ ìˆì–´, ê¸ˆìœµë‹¹êµ­ì€ ìŠ¤íŠ¸ë ˆìŠ¤ DSR ì‹œë®¬ë ˆì´ì…˜ì„ ì •ë¡€í™”í•˜ê² ë‹¤ê³  ë°í˜”ë‹¤.",
  "ë¹„íŠ¸ì½”ì¸ í˜„ë¬¼ ETF ìê¸ˆ ìœ ì…ì´ ì¬ê°œë˜ë©° ë³€ë™ì„±ì´ í™•ëŒ€ëê³ , ì¥ì¤‘ ê³ ì  ëŒíŒŒ ì—¬ë¶€ê°€ ì—°ë§ì¥ì„¸ì˜ ë¶„ìˆ˜ë ¹ì´ ë  ì „ë§ì´ë‹¤.",
  "ëŒ€ì¶œ ê¸ˆë¦¬ ìƒë‹¨ì€ ì œí•œëìœ¼ë‚˜ ê¸°ì¤€ê¸ˆë¦¬ ê²½ë¡œê°€ ë¶ˆí™•ì‹¤í•´ ê³ ì •Â·ë³€ë™ ì¤‘ ì–´ëŠ í•œìª½ì— ë² íŒ…í•˜ê¸°ë³´ë‹¤ í˜¼í•© ì „ëµì´ ìœ ë¦¬í•˜ë‹¤ëŠ” í‰ê°€ë‹¤.",
  "ì„ëŒ€ì¸ì˜ ì±„ë¬´ë¶ˆì´í–‰ ë¦¬ìŠ¤í¬ê°€ í™•ì¸ë  ê²½ìš°, ê³„ì•½ê¸ˆ ë°˜í™˜ íŠ¹ì•½ê³¼ ë‹¨ê³„ë³„ ì•ˆì „ì¥ì¹˜ë¥¼ ë¬¸ì„œë¡œ ë‚¨ê¸°ëŠ” ê²Œ ë¶„ìŸ ì˜ˆë°©ì— íš¨ê³¼ì ì´ë‹¤.",
  "ì§€ë°© ì¤‘ì†Œë„ì‹œì—ì„œëŠ” ì‹ ê·œ ì…ì£¼ ë¬¼ëŸ‰ê³¼ ë¯¸ë¶„ì–‘ ì ì²´ê°€ ë™ì‹œ ë°œìƒí•˜ë©° ì²´ê°ê°€ê²©ì´ í•˜ë°© ì••ë ¥ì„ ë°›ê³  ìˆë‹¤.",
  "ì‹ ê·œ ì²­ë…„ ì „ì„¸ëŒ€ì¶œì€ ë³´ì¦ í•œë„ê°€ ìƒí–¥ëì§€ë§Œ ë³´ì¦ë£Œ ì¸ìƒìœ¼ë¡œ ì‹¤íš¨ì„±ì— ëŒ€í•œ ë…¼ìŸì´ ì´ì–´ì§„ë‹¤.",
  "ë¶€ë™ì‚° ë°ì´í„° í”Œë«í¼ë“¤ì€ êµ¬ë³„ ê±°ë˜ëŸ‰ê³¼ ê°€ê²© ë¶„í¬ë¥¼ ì‹œê°í™”í•˜ë©° ì²´ê³„ì ì¸ ë¹„êµ ë„êµ¬ë¥¼ ì œê³µí•˜ê¸° ì‹œì‘í–ˆë‹¤.",
  "ì •ì±… ë³€ìˆ˜ì™€ ê¸ˆë¦¬ ì—¬ê±´ì´ êµì°¨í•˜ëŠ” êµ­ë©´ì—ì„œ íˆ¬ì íŒë‹¨ì€ ë³´ìˆ˜ì ìœ¼ë¡œ ì ‘ê·¼í•˜ë¼ëŠ” ì¡°ì–¸ì´ í˜ì„ ì–»ëŠ”ë‹¤.",
  "ì „ë¬¸ ë³€í˜¸ì‚¬ë“¤ì€ ë‚´ìš©ì¦ëª…ê³¼ ì¡°ì • ì ˆì°¨ë¥¼ í†µí•´ ì¥ê¸° ì†Œì†¡ìœ¼ë¡œ ë²ˆì§€ëŠ” ì¼ì„ ìµœì†Œí™”í•˜ë¼ê³  ê¶Œí•œë‹¤.",
  "ì „ì„¸ ì‚¬ê¸°ì˜ ì „í˜•ì  íŒ¨í„´ì€ ì¡°ì§ì  ë¸Œë¡œì»¤ ê°œì…ê³¼ í—ˆìœ„ ì‹œì„¸ ì œì‹œ ë“±ìœ¼ë¡œ ë°˜ë³µë˜ë©°, ì˜ˆë°© êµìœ¡ì˜ ì¤‘ìš”ì„±ì´ ì»¤ì§€ê³  ìˆë‹¤.",
  "ìµœê·¼ ë°œí‘œëœ í†µê³„ëŠ” ë³´ì¦ ì‚¬ê³  ê¸ˆì•¡ì´ ì†Œí­ ë‘”í™”ëì§€ë§Œ ì§€ì—­ë³„ í¸ì°¨ê°€ í¬ê²Œ ë²Œì–´ì¡ŒìŒì„ ë³´ì—¬ì¤€ë‹¤.",
  "ì„ì°¨ì¸ ë³´í˜¸ë¥¼ ìœ„í•œ ë””ì§€í„¸ ì„œë¥˜ ê²€ì¦ì´ í™•ì‚°ë˜ë©´ì„œ ê³„ì•½ ê³¼ì •ì˜ íˆ¬ëª…ì„±ì´ ê³¼ê±°ë³´ë‹¤ ë†’ì•„ì¡Œë‹¤ëŠ” í‰ê°€ë„ ìˆë‹¤.",
  "ì‹œì¥ ì°¸ì—¬ìë“¤ì€ ê¸ˆë¦¬ì™€ ê³µê¸‰, ì •ì±… 3ìš”ì†Œê°€ ë™ì‹œì— ì™„í™”ë˜ëŠ” ì‹œì ì„ ì „í™˜ì ìœ¼ë¡œ ë³´ê³  ê´€ë§ì„¸ë¥¼ ìœ ì§€í•˜ëŠ” ë¶„ìœ„ê¸°ë‹¤."
];
function makeParagraph(min=6,max=12){
  const count=randInt(min,max), used=new Set(), out=[];
  while(out.length<count){
    const i=randInt(0,DUMMY_SENTENCES.length-1);
    if(used.has(i)) continue;
    used.add(i); out.push(DUMMY_SENTENCES[i]);
  }
  return out.join(' ');
}

/* ================================
   ìƒíƒœ/ìš”ì†Œ
================================ */
let currentType='news';
let nextCursor=null, reachedEnd=false, loading=false;
let topRemovedCount=0, topSpacerPx=0;

const listEl=document.getElementById('list');
const topSpacer=document.getElementById('topSpacer');
const sentinel=document.getElementById('sentinel');

const pageTitleEl  = document.getElementById('pageTitle');
const viewerTitleEl= document.getElementById('viewerTitle');

/* ì œëª© ë™ê¸°í™” */
function setTitleByType(type){
  const label = (type==='news')? 'ë‰´ìŠ¤' : 'í™ë³´';
  pageTitleEl.textContent = label;
  viewerTitleEl.textContent = label;
  document.title = `${label} â€“ ë¬´í•œìŠ¤í¬ë¡¤Â·ìŠ¬ë¼ì´ë”Â·ë³´ê¸°`;
}
function applyActiveTab(){
  document.querySelectorAll('.tab').forEach(t=>{
    const active = t.dataset.type === currentType;
    t.classList.toggle('is-active', active);
    t.setAttribute('aria-selected', active ? 'true' : 'false');
  });
}

/* Tabs */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    if(tab.classList.contains('is-active'))return;
    document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('is-active');t.setAttribute('aria-selected','false');});
    tab.classList.add('is-active');tab.setAttribute('aria-selected','true');
    currentType=tab.dataset.type;

    setTitleByType(currentType);
    history.replaceState(null, '', `${location.pathname}?type=${currentType}`);

    nextCursor=null; reachedEnd=false; loading=false;
    topRemovedCount=0; topSpacerPx=0; topSpacer.style.height='0';
    listEl.innerHTML='';
    loadNextPage();
  });
});

/* ================================
   Fetch (mock) â€” ì‹¤ì œ ì„œë²„ë¡œ êµì²´ ê°€ëŠ¥
================================ */
async function fetchPageFromServer(type,cursor,limit){
  await new Promise(r=>setTimeout(r,200));
  const start=cursor?parseInt(cursor,10):0;
  const end=start+limit;
  const items=[];
  for(let i=start;i<end;i++){
    const id=`${type}-${i}`, seed=`${type}-${i}-${randInt(1,9999)}`;
    items.push({
      id,
      title: makeParagraph(6,12),
      images:[
        `https://picsum.photos/seed/${seed}-1/560/700`,
        `https://picsum.photos/seed/${seed}-2/560/700`,
        `https://picsum.photos/seed/${seed}-3/560/700`,
      ],
      date:new Date(Date.now()-i*86400000).toISOString().slice(0,10)
    });
  }
  const mockTotal=10000;
  return {items,nextCursor:end>=mockTotal?null:String(end)};
}

/* ================================
   Infinite + Virtual Scroll
================================ */
async function loadNextPage(){
  if(loading||reachedEnd) return;
  loading=true;
  try{
    const {items,nextCursor:nc}=await fetchPageFromServer(currentType,nextCursor,PAGE_SIZE);
    nextCursor=nc;
    if(!items||!items.length) reachedEnd=true;
    else{ appendCards(items); if(!nc) reachedEnd=true; }
  } finally{ loading=false; }
}
function appendCards(items){ for(const row of items){listEl.appendChild(buildCard(row));} virtualTrimIfNeeded(); }
function virtualTrimIfNeeded(){
  const cards=listEl.children.length;
  if(cards<=MAX_DOM_CARDS)return;
  const removeCount=Math.min(cards-MAX_DOM_CARDS,Math.floor(MAX_DOM_CARDS/2));
  let removedHeight=0;
  for(let i=0;i<removeCount;i++){
    const first=listEl.firstElementChild; if(!first)break;
    removedHeight+=first.getBoundingClientRect().height||EST_CARD_HEIGHT;
    listEl.removeChild(first); topRemovedCount++;
  }
  topSpacerPx+=removedHeight; topSpacer.style.height=topSpacerPx+'px';
  window.scrollBy(0,-removedHeight);
}
const io=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)loadNextPage();});},{root:null,rootMargin:'800px 0px 800px 0px'});
io.observe(sentinel);

/* ================================
   ê³µìš© í¬ì¸í„° ìŠ¤ì™€ì´í”„ ìœ í‹¸ (ìˆ˜ì§ ìŠ¤í¬ë¡¤ ì‹œ íƒ­ ë¬´íš¨ + ì—ì§€ ë’¤ë¡œê°€ê¸°)
================================ */
function setupPointerSwipe(
  container,
  {
    onSwipeLeft,
    onSwipeRight,
    onTap,
    onBack,                // â† ì¢Œì¸¡ ì—ì§€ ìŠ¤ì™€ì´í”„ ë°± í•¸ë“¤ëŸ¬
    lockThreshold = 12,    // ë°©í–¥ ê²°ì • ì„ê³„ì¹˜
    swipeThreshold = 55,   // ìŠ¤ì™€ì´í”„ ì„ê³„ì¹˜
    tapMoveTolerance = 6,  // íƒ­ í—ˆìš© ì´ë™
    tapTime = 320,         // íƒ­ í—ˆìš© ì‹œê°„
    scrollTolerance = 4,   // íƒ­ ë™ì•ˆ í—ˆìš© ìŠ¤í¬ë¡¤ ë³€í™”
    edgeBackWidth = 24,    // ì¢Œì¸¡ ì—ì§€ ì˜ì—­(px)
    enableWhen = () => true
  } = {}
){
  if (!USE_POINTER) return null;

  let sx=0, sy=0, dx=0, dy=0;
  let lock = null;          // 'h' | 'v' | null
  let tracking = false;
  let pid = null;
  let captured = false;
  let t0 = 0;
  let startScrollY = 0;

  const getScrollTop = () =>
    window.pageYOffset ||
    document.documentElement.scrollTop ||
    document.body.scrollTop ||
    0;

  const onDown = (e)=>{
    if (!enableWhen()) return;
    if (e.target.closest('button, .mini-dots, .viewer-dots')) return;

    tracking = true;
    pid = e.pointerId;
    captured = false;      // ìˆ˜í‰ í™•ì • ì „ì—ëŠ” ìº¡ì²˜ ê¸ˆì§€
    sx = e.clientX; sy = e.clientY;
    dx = dy = 0; lock = null;
    t0 = Date.now();
    startScrollY = getScrollTop();
  };

  const onMove = (e)=>{
    if (!tracking) return;
    dx = e.clientX - sx; dy = e.clientY - sy;

    // ë°©í–¥ ì ê¸ˆ ê²°ì •
    if (lock == null && (Math.abs(dx) > lockThreshold || Math.abs(dy) > lockThreshold)) {
      lock = Math.abs(dx) > Math.abs(dy) ? 'h' : 'v';

      // ìˆ˜í‰ í™•ì • â†’ ê·¸ë•Œë§Œ ìº¡ì²˜
      if (lock === 'h' && !captured) {
        container.setPointerCapture?.(pid);
        captured = true;
      } else if (lock === 'v' && captured) {
        try { container.releasePointerCapture?.(pid); } catch {}
        captured = false;
      }
    }
  };

  const onUp = (e)=>{
    if (!tracking) return;
    const dt = Date.now() - t0;
    const scDiff = Math.abs(getScrollTop() - startScrollY);

    // ì—ì§€ ìŠ¤ì™€ì´í”„: ì¢Œì¸¡ ê°€ì¥ìë¦¬ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ í° ì´ë™
    if (lock === 'h' && sx <= edgeBackWidth && dx > swipeThreshold) {
      onBack?.();
    }
    // ì¼ë°˜ ìˆ˜í‰ ìŠ¤ì™€ì´í”„
    else if (lock === 'h' && Math.abs(dx) > swipeThreshold) {
      dx < 0 ? onSwipeLeft?.() : onSwipeRight?.();
    }
    // íƒ­: ë°©í–¥ ë¯¸ê²°ì • ìƒíƒœì—ì„œë§Œ ì¸ì •(ìˆ˜í‰/ìˆ˜ì§ ì œìŠ¤ì²˜ ì•„ë‹ˆì–´ì•¼ í•¨)
    else if (lock == null &&
             scDiff <= scrollTolerance &&
             dt < tapTime &&
             Math.abs(dx) < tapMoveTolerance &&
             Math.abs(dy) < tapMoveTolerance) {
      onTap?.(e);
    }
    // ê·¸ ì™¸: ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨ (ì„¸ë¡œ ìŠ¤í¬ë¡¤)

    tracking = false;
    lock = null;
    if (captured) {
      try { container.releasePointerCapture?.(pid); } catch {}
    }
    captured = false;
    pid=null;
  };

  const onCancel = onUp;

  container.addEventListener('pointerdown', onDown);
  container.addEventListener('pointermove', onMove);
  container.addEventListener('pointerup', onUp);
  container.addEventListener('pointercancel', onCancel);
  container.addEventListener('lostpointercapture', onCancel);

  return {
    destroy(){
      container.removeEventListener('pointerdown', onDown);
      container.removeEventListener('pointermove', onMove);
      container.removeEventListener('pointerup', onUp);
      container.removeEventListener('pointercancel', onCancel);
      container.removeEventListener('lostpointercapture', onCancel);
    }
  };
}

/* ================================
   Card
================================ */
function buildCard(row){
  const card=document.createElement('article'); card.className='card';
  const imgs=row.images?.length?row.images:[placeholder()];
  card.innerHTML=`
    <div class="mini-slider" data-index="0">
      <div class="mini-slides"></div>
      <div class="mini-nav">
        <button class="mini-prev" aria-label="ì´ì „">â€¹</button>
        <button class="mini-next" aria-label="ë‹¤ìŒ">â€º</button>
      </div>
    </div>
    <div class="mini-dots"></div>
    <div>
      <div class="caption" tabindex="0" aria-expanded="false"></div>
      <button class="more-btn" type="button">â€¦ ë”ë³´ê¸°</button>
    </div>
    <div class="meta">${row.date}</div>`;
  const cap=card.querySelector('.caption'); cap.textContent=row.title;
  const btn=card.querySelector('.more-btn');
  btn.addEventListener('click',()=>{const expanded=cap.classList.toggle('expanded');cap.setAttribute('aria-expanded',expanded);btn.textContent=expanded?'ì ‘ê¸°':'â€¦ ë”ë³´ê¸°';});
  cap.addEventListener('click',()=>btn.click());
  requestAnimationFrame(()=>{btn.hidden=!(cap.scrollHeight>cap.clientHeight+1);});
  buildMiniSlider(card,imgs,{title:row.title,date:row.date});
  return card;
}

/* ================================
   ë©”ì¸ ìŠ¬ë¼ì´ë” (ìˆ˜í‰ ì œìŠ¤ì²˜ëŠ” ì „í™˜/íƒ­ ê¸ˆì§€)
================================ */
function buildMiniSlider(card,srcs,meta){
  const slider=card.querySelector('.mini-slider');
  const slidesEl=card.querySelector('.mini-slides');
  const dotsEl=card.querySelector('.mini-dots');
  slidesEl.innerHTML=''; dotsEl.innerHTML='';

  const imgs=(srcs||[]).slice(0,MAX_IMAGES);
  imgs.forEach((src,i)=>{
    const s=document.createElement('div'); s.className='mini-slide';
    s.innerHTML=`<img src="${src}" alt="ì´ë¯¸ì§€ ${i+1}">`; 
    slidesEl.appendChild(s);
    const d=document.createElement('div'); d.className='mini-dot';
    d.addEventListener('click',()=>goTo(slider,i));
    dotsEl.appendChild(d);
  });

  // ì¢Œ/ìš° ë²„íŠ¼
  card.querySelector('.mini-prev').addEventListener('click',()=>goStep(slider,-1));
  card.querySelector('.mini-next').addEventListener('click',()=>goStep(slider,+1));

  // í¬ì¸í„° ì œìŠ¤ì²˜: ìˆ˜í‰ ìŠ¤ì™€ì´í”„ â†’ ì „í™˜, ì¢Œì¸¡ ì—ì§€ â†’ ë’¤ë¡œê°€ê¸°(ë©”ì¸ì€ history.back ì‹œë„ X)
  setupPointerSwipe(slider, {
    onSwipeLeft:  ()=> goStep(slider,+1),
    onSwipeRight: ()=> goStep(slider,-1),
    onTap: (e)=>{ // ìˆ˜ì§ íƒ­ë§Œ ì—´ê¸°
      if (e.target.closest('button,.mini-dots')) return;
      if (!canOpenNow()) return;
      e.preventDefault(); e.stopPropagation();
      openViewer(imgs, meta?.title||'', meta?.date||'');
    },
    onBack: null,            // ë©”ì¸ì—ì„œëŠ” ë’¤ë¡œê°€ê¸° ë™ì‘ ì—†ìŒ
    lockThreshold: 12,
    swipeThreshold: 55,
    tapMoveTolerance: 6,
    tapTime: 320,
    scrollTolerance: 4,
    edgeBackWidth: 24,
    enableWhen: ()=> true
  });

  // í´ë¦­ í´ë°±: PointerEvent ë¯¸ì§€ì› í™˜ê²½ì—ì„œë§Œ
  if (!USE_POINTER){
    slider.addEventListener('click', (e)=>{
      if (e.target.closest('button,.mini-dots')) return;
      if (!canOpenNow()) return;
      openViewer(imgs, meta?.title||'', meta?.date||'');
    });
  }

  setIndex(slider,0);
}
function setIndex(slider,i){
  const slidesEl=slider.querySelector('.mini-slides');
  const total=slidesEl.children.length;
  const idx=Math.max(0,Math.min(total-1,i));
  slider.dataset.index=String(idx);
  slidesEl.style.transform=`translateX(${-idx*100}%)`;
  const dots=slider.parentElement.querySelectorAll('.mini-dot');
  dots.forEach((d,k)=>d.classList.toggle('active',k===idx));
  if(idx>=1&&total>1)slider.classList.add('show-nav'); else slider.classList.remove('show-nav');
  slider.querySelector('.mini-prev').disabled=(idx===0);
  slider.querySelector('.mini-next').disabled=(idx===total-1);
}
const goTo=(slider,i)=>setIndex(slider,i);
const goStep=(slider,step)=>setIndex(slider,(+slider.dataset.index||0)+step);

/* ================================
   Viewer (ì‚¬ì§„ íƒ­ ì‹œ ë‹«í˜) + ê³µìœ  + ì¬ìƒ + í•€ì¹˜ì¤Œ + ì—ì§€ ë’¤ë¡œê°€ê¸°
================================ */
const viewer      = document.getElementById('viewer');
const backdrop    = document.getElementById('viewer-backdrop');
const vSlidesEl   = document.getElementById('viewerSlides');
const vDotsEl     = document.getElementById('viewerDots');
const vCaptionEl  = document.getElementById('viewerCaption');
const vDateEl     = document.getElementById('viewerDate');
const vPrevBtn    = document.getElementById('viewerPrev');
const vNextBtn    = document.getElementById('viewerNext');
const vCloseBtn   = document.getElementById('viewerCloseBtn');
const vListBtn    = document.getElementById('viewerListBtn');
const vShareBtn   = document.getElementById('viewerShareBtn');
const vPlayBtn    = document.getElementById('viewerPlayBtn');
const vSliderBox  = document.getElementById('viewerSlider');

let vIdx = 0;
let autoplayTimer = null;
const AUTOPLAY_MS = 3000;
let isAutoplaying = false;

/* Zoom/Pan state */
let zScale = 1, zTx = 0, zTy = 0;
const Z_MIN = 1, Z_MAX = 4;
let pinchStartDist = 0, pinchStartScale = 1;
let panStartX = 0, panStartY = 0, panStartTx = 0, panStartTy = 0;
let isPanning = false, isPinching = false;
/* íƒ­ ë°©ì§€ */
let suppressTapClose = false;
function blockTapCloseBrief(){ suppressTapClose = true; setTimeout(()=>{ suppressTapClose = false; }, 250); }

function viewerImgEl(){ const slide = vSlidesEl.children[vIdx]; return slide ? slide.querySelector('img') : null; }
function resetZoom(){ zScale=1; zTx=0; zTy=0; const img=viewerImgEl(); if(img) img.style.transform=`translate(0px,0px) scale(1)`; vSliderBox.classList.remove('is-zoomed','is-panning'); }
function applyZoom(){ const img=viewerImgEl(); if(!img) return; img.style.transform=`translate(${zTx}px,${zTy}px) scale(${zScale})`; if(zScale>1) vSliderBox.classList.add('is-zoomed'); else vSliderBox.classList.remove('is-panning','is-zoomed'); }
function clampPan(){ const boxW=vSliderBox.clientWidth, boxH=vSliderBox.clientHeight; const maxX=(boxW*(zScale-1))/2, maxY=(boxH*(zScale-1))/2; zTx=Math.max(-maxX,Math.min(maxX,zTx)); zTy=Math.max(-maxY,Math.min(maxY,zTy)); }

function openViewer(imgs, caption, date){
  vSlidesEl.innerHTML=''; vDotsEl.innerHTML='';
  const list=(imgs||[]).slice(0,MAX_IMAGES);
  list.forEach((src,i)=>{
    const s=document.createElement('div'); s.className='viewer-slide';
    s.innerHTML=`<img src="${src}" alt="ì´ë¯¸ì§€ ${i+1}">`;
    vSlidesEl.appendChild(s);
    const d=document.createElement('div'); d.className='viewer-dot'; d.addEventListener('click', (e)=>{ e.stopPropagation(); viewerGoTo(i); }); vDotsEl.appendChild(d);
  });

  vCaptionEl.textContent = caption || '';
  vDateEl.textContent = date || '';
  vIdx=0; viewerUpdate(); resetZoom();

  viewer.style.display='block'; backdrop.style.display='block';
  viewer.setAttribute('aria-hidden','false');
  document.addEventListener('keydown', escCloseOnce);
  document.body.classList.add('no-scroll');
  stopAutoplay();

  /* ë°©ê¸ˆ ì—´ë¦° ë’¤ í•©ì„± í´ë¦­ í¡ìˆ˜ (Android) */
  justOpenedShield();

  /* ë·°ì–´ ë‚´ë¶€ í¬ì¸í„° ì œìŠ¤ì²˜: ì¢Œì¸¡ ì—ì§€ ìŠ¤ì™€ì´í”„ â†’ ë‹«ê¸°(ë’¤ë¡œê°€ê¸°) */
  setupPointerSwipe(vSliderBox, {
    onSwipeLeft : ()=>{ if(zScale===1) viewerStep(+1); },
    onSwipeRight: ()=>{ if(zScale===1) viewerStep(-1); },
    onTap: (e)=>{ // ì´ë¯¸ì§€ íƒ­ ì‹œ ë‹«ê¸° (ìˆ˜ì§ íƒ­ë§Œ)
      if (suppressTapClose) return;
      if (Date.now() - lastOpenTs < 150) return; // ì—´ìë§ˆì ë‹«í˜ ë°©ì§€
      if (e.target && e.target.closest('.viewer-slide img')) closeViewer();
    },
    onBack: ()=>{ if(zScale===1) closeViewer(); }, // â† ì¢Œì¸¡ ì—ì§€ì—ì„œ ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„
    lockThreshold: 12,
    swipeThreshold: 55,
    tapMoveTolerance: 6,
    tapTime: 320,
    scrollTolerance: 4,
    edgeBackWidth: 24,
    enableWhen: ()=> true
  });
}
function closeViewer(){
  stopAutoplay();
  viewer.style.display='none'; backdrop.style.display='none';
  viewer.setAttribute('aria-hidden','true');
  document.removeEventListener('keydown', escCloseOnce);
  document.body.classList.remove('no-scroll');
  noteClosed();
}
function escCloseOnce(e){ if(e.key==='Escape') closeViewer(); if(e.key==='ArrowLeft') viewerStep(-1); if(e.key==='ArrowRight') viewerStep(+1); }

function viewerGoTo(i){ const total=vSlidesEl.children.length; vIdx=Math.max(0,Math.min(total-1,i)); viewerUpdate(); resetZoom(); }
function viewerStep(step){ viewerGoTo(vIdx+step); }
function viewerUpdate(){
  vSlidesEl.style.transform = `translateX(-${vIdx*100}%)`;
  [...vDotsEl.children].forEach((d,i)=> d.classList.toggle('active', i===vIdx));
  vPrevBtn.disabled = (vIdx===0);
  const total = vSlidesEl.children.length;
  vNextBtn.disabled = (vIdx===total-1);
}

/* Autoplay */
function startAutoplay(){ if(isAutoplaying) return; isAutoplaying=true; vPlayBtn.textContent='ì¼ì‹œì •ì§€';
  autoplayTimer=setInterval(()=>{ const total=vSlidesEl.children.length; if(vIdx>=total-1) viewerGoTo(0); else viewerStep(+1); }, AUTOPLAY_MS); }
function stopAutoplay(){ isAutoplaying=false; vPlayBtn.textContent='ì¬ìƒ'; if(autoplayTimer){clearInterval(autoplayTimer); autoplayTimer=null;} }

/* Share */
async function shareCurrent(){
  const img=viewerImgEl(); if(!img) return;
  const title=(pageTitleEl?.textContent||'ë‰´ìŠ¤&í™ë³´'); const text=vCaptionEl.textContent||'';
  const prev=vShareBtn.textContent; vShareBtn.disabled=true; vShareBtn.textContent='ê³µìœ  ì¤€ë¹„ ì¤‘â€¦';
  try{
    const res=await fetch(img.src,{mode:'cors',cache:'no-store'}); const blob=await res.blob();
    const mime=blob.type||'image/jpeg'; const ext=(mime.split('/')[1]||'jpg').replace('jpeg','jpg'); const file=new File([blob],`image.${ext}`,{type:mime});
    if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({title,text,files:[file]}); }
    else if(navigator.share){ await navigator.share({title,text,url:img.src}); }
    else if(navigator.clipboard && window.ClipboardItem){ try{ await navigator.clipboard.write([ new ClipboardItem({[mime]:blob}) ]); alert('ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(e){ await navigator.clipboard.writeText(`${text}\n${img.src}`); alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); } }
    else { const a=document.createElement('a'); a.href=img.src; a.download=`image.${ext}`; document.body.appendChild(a); a.click(); a.remove(); }
  }catch(e){
    try{ await navigator.clipboard.writeText(img.src); alert('ì´ë¯¸ì§€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(_){ prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', img.src); }
  }finally{ vShareBtn.disabled=false; vShareBtn.textContent=prev; }
}

/* ë°°ê²½/ì‹œíŠ¸ íƒ­ì€ ë‹«í˜ ì—†ìŒ */
backdrop.addEventListener('click', e=>e.stopPropagation());
viewer  .addEventListener('click', e=>e.stopPropagation());

/* ì»¨íŠ¸ë¡¤ */
[vPrevBtn, vNextBtn, vCloseBtn, vListBtn, vShareBtn, vPlayBtn].forEach(btn=>{
  btn.addEventListener('click', (e)=> e.stopPropagation());
});
vPrevBtn.addEventListener('click', ()=> viewerStep(-1));
vNextBtn.addEventListener('click', ()=> viewerStep(+1));
vCloseBtn.addEventListener('click', closeViewer);
vListBtn .addEventListener('click', closeViewer);
vShareBtn.addEventListener('click', shareCurrent);
vPlayBtn .addEventListener('click', ()=>{ isAutoplaying ? stopAutoplay() : startAutoplay(); });

/* Helper */
function placeholder(){
  return "data:image/svg+xml;utf8,"+encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='560' height='700'>
      <rect width='100%' height='100%' rx='12' fill='#dddddd'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#333' font-size='28'>280Ã—350</text>
    </svg>`
  );
}

/* ì´ˆê¸° ë¡œë“œ */
{
  const urlType = new URLSearchParams(location.search).get('type');
  if (urlType === 'news' || urlType === 'pr') currentType = urlType;
  applyActiveTab();
  setTitleByType(currentType);
  loadNextPage();
}
</script>
</body>
</html>
